m{% extends "base.html" %}
{% load metadataform_tags %}

{% block extra_styles %}<link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/library.css" />{% endblock %}

{% block custom_scripts %}
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jstree/jstree.core.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jstree/jstree.contextmenu.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jstree/jstree.themes.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jstree/jstree.html.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jstree/jstree.ui.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jstree/jstree.dnd.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jstree/vakata.js"></script>
    
    
    <script type="text/javascript">
        var media_url = "{{ MEDIA_URL }}";
        var app_url = "{{ request.META.SCRIPT_NAME }}";
	</script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/inflection.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/application.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/libraryitems.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/collectionitems.js"></script>
	<script type="text/javascript">
		
		$(document).ready(function() {
			
            /* File upload - using iframe as the target */
            $("#upload_target").load(function() {
				var ret = $("#upload_target").contents().find("body").html();
				ret = ret.replace('<pre style="word-wrap: break-word; white-space: pre-wrap;">','') //Remove the crap that safari adds
				ret = ret.replace("<pre>",'')
				ret = ret.replace("</pre>",'')
				
				if (ret == "File type is not supported, please try again"){
					$("#upload-error").html(ret)
					$("#id_file").val(null)
				} else {
					var data = eval("("+ ret +")"); //Parse JSON
                    var asset_item = '<li data-node-class="Asset" id="folders_node_'+ data[0].pk + '" class="jstree-leaf" ><ins class="jstree-icon jstree-ocl">&nbsp;</ins><a href="#'+ data[0].pk + '"><ins class="jstree-icon jstree-themeicon">&nbsp;</ins>'+ data[0].fields.name + '</a></li>'
					$("#folder_tree > ul").prepend(asset_item);
					initialize_folder_tree();
					
					// Clear the form values after upload
					$('#fileupload-form:input')
						.not(':button, :submit, :reset, :hidden')
						.val('')
						.removeAttr('checked')
						.removeAttr('selected');
					$('#document-upload').show();
				}
			}); //End: #upload_target.load
			
			$('#id_file').click(function() {
				var findFileField = $(this).attr('class');
				$('#'+findFileField).click();
				});
			
            /* When files are clicked from the folder area - display the details in the metadata section */
  			$(".items li a, [data-node-class=Asset]").click(function(){
                var asset_id = strip_id_prefix($(this), "node_");
                asset_id = asset_id.replace('folders_','');
                $.ajax({
					url: '{% url ajax_get_asset %}',
					dataType: "json",
					data: {
						asset: asset_id
					}, 
					success: function( data ) {
						if (data.error) {
							alert (data.error)
							return false;
						}
						$('#metadata-details').html('<ul><li>'+data[0].fields.name+'</li></ul> <input type="hidden" id="selected-item" name="selected-item" value="'+data[0].pk+'" />')
					}
				}); //End ajax call
 			}); // End .items li click

            /* When files are clicked from the files area in the main section - display the details in the metadata section */
            $("#files .items li").click(function(){
                var asset_id = strip_id_prefix($(this), "node_");
                asset_id = asset_id.replace('folders_','');
                $.ajax({
                    url: '{% url ajax_get_asset %}',
                    dataType: "json",
                    data: {
                        asset: asset_id
                    }, 
                    success: function( data ) {
                        if (data.error) {
                            alert (data.error)
                            return false;
                        }
                        var asset = eval( '(' + data.asset + ')' )
                        var related_meta_data = eval( '(' + data.related_meta_data + ')' )
                        //alert (related_meta_data[0].pk)
                        var meta_data_list = ''
                        for (i=0;i<related_meta_data.length;i++) {
                            meta_data_list += '<li>'+ related_meta_data[i].fields.fieldname +' - '+ related_meta_data[i].fields.value +'</li>'
                        }
                        $('#metadata-details').html('<ul><li>'+asset[0].fields.name+'</li>'+ meta_data_list +'</ul> <input type="hidden" id="selected-item" name="selected-item" value="'+asset[0].pk+'" />')
                    }
                }); //End ajax call
            }); // End .items li click
 			
			$('#metadata-form').submit(function(){
				event.preventDefault();
				$.ajax({
					url: '{% url ajax_save_metadata %}',
					dataType: "json",
					data: {
						asset: $('#selected-item').val(),
						fieldname: $('#id_fieldname').val(),
						value: $('#id_value').val(),
						owner: $('#id_owner').val()
					}, 
					success: function( data ) {
						if (data.error) {
							alert (data.error)
							return false;
						}
						$('#metadata-details').html('<ul><li>'+data[0].fields.name+'</li></ul>')
					}
					
				}); //End ajax call
			
			}); // End: #metadata-form submit
		});
    </script>
{% endblock %}

{% block title %}
    {{ requested_user.first_name }} {{ requested_user.last_name }}'s Library
{% endblock %}


{% block content %}
        
    <div id="panels">

        <div id="left">
            <header class="panelheader">
                <h2>Folders</h2>
            </header>
            <div class="handle"></div>
            
            <div id="folders">
                <div id="folder_tree">
                    {% include "libraryitems/index.html" %}   
                </div>  
                {% if requested_user == current_user %}
                    <a id="new_folder" class="button modal" href="{{ request.META.SCRIPT_NAME }}/folders/new">new&nbsp;folder</a>
                {% endif %}          
            </div>  
            
            <div id="collections">
                <h2>Your Collections</h2>                
                <div id="collection_tree">
                    {% include "usercollections/index.html" %}
                </div>
                {% if requested_user == current_user %}
                    <a id="new_collection" class="button modal" href="{{ request.META.SCRIPT_NAME }}/collections/new">new&nbsp;collection</a>
                {% endif %}
                
            </div>
       </div><!--/#left-->
       
        
        <div id="library" role="main" class="center">
        
            <div id="library-items">
        
                <header class="panelheader">
                    <h2>Your items</h2>
                    <ul class="view">
                        <li><a class="button active" href="#" id="list_view">List</a></li>
                        <li><a class="button" href="#" id="icon_view">Icon</a></li>
                    </ul>
                </header>
            	
				{% if current_assets %}
                    <div id="files" class="innerpane">
                        <header>
                            <abbr class="size">Size</abbr>
                            <abbr class="modified">Last Modified</abbr>
                            <abbr class="filetype">Type</abbr>
                            <h3>Item</h3>
                        </header>
                        <ol class="items"> 
							{% for asset in current_assets %}
                                <li id="{{asset.id}}">
                                    <a href="#">
                                        <abbr class="size">{{ asset.file.size|filesizeformat }}</abbr>
                                        <abbr class="modified">{{ asset.modified|timesince }} ago</abbr>
                                        <abbr class="filetype">
                                            {% for type in asset.filetype.all %}
                                                {{ type.name }}
                                            {% endfor %}
                                        </abbr>
                                        <h3>{{ asset.name }}</h3>                                        
                                    </a>
                                </li>  
							{% endfor %}                             
                        </ol>
                    </div>  

				{% endif %}
				
                <iframe id="upload_target" name="upload_target" src="" style="width:0px;height:0px;"></iframe>
                <div id="fileupload">
                    Add an item using the form below:
                    <form action="{% url ajax_create_asset %}" method="post" enctype="multipart/form-data" id="fileupload-form" target="upload_target">{% csrf_token %}
                    <p>
                        {{ file_upload_form.file }}
                    </p>
                    <!-- This is the file input goes -->
                    <noscript>          
                    	<p>Please enable JavaScript to use file uploader.</p>
                        <!-- or put a simple form for upload here -->
                    </noscript> 
                    <input type="submit" value="Upload File" />
                    
                    </form>
                </div>	 
                
            </div><!--/#library-items-->
                    
        </div><!--/#library-->
        
        <div id="right">
            <header class="panelheader">
                    <h2>Meta</h2>
            </header>
            <div class="handle"></div>
            <!--<div class="meta default">
                <div class="data">
                    <div class="preview empty">
                        No item Selected!
                    </div>
                </div>
            </div>-->
            <div class="meta">
                <div class="data">
                    <p id="metadata-details"></p>
                    <p> Add new metadata</p>
                    {% display_metadata_form request %}
                </div>
            </div>
        </div><!--/#right-->
        
    </div><!--/#panels-->
        
{% endblock %}

{% block footer %}	
        
    <div id="upload">
        <p>Upload +</p>
    </div>
        
    <nav id="actions">
        <ul>
            <li><a href="#">Edit</a></li>
            <li><a href="#">Reflect</a></li>
            <li><a href="#">Publish</a></li>
            <li><a href="#">Share</a></li>
            <li><a href="#">Submit</a></li>
        </ul>
    </nav>

{% endblock %}